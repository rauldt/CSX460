---
title: "Caret / Recursive Partitioning"
author: "Raul Torres"
date: "05/15/2017"
output: html_document
---

```{r init, warning=FALSE, echo=FALSE, message=FALSE}
library(rpart)
library(caret)
library(dplyr)
library(pROC)
# .. Additional libraries
```


# Exercise 1: caret/logistic regression (5 points)


### Load data and define dependent variable
```{r}
# Load data
data_orig <- read.csv("C:/Users/rtorres/Desktop/MachLearn/MyUser/CSX460/03-linear-regression/03-exercise-nycflights-model/NYCflights.csv", stringsAsFactors = FALSE)
data <- data_orig

# Create a binary dependent variable that is 1 when flight is late (arr_delay > 22 minutes), 0 otherwise. 
data$y <- as.numeric(data$arr_delay >= 22)

# Remove rows where predictions won't be fesible due to missingness in covariates (or response variable)
data <- na.omit(data[,c("y","dep_delay","month.flight","air_time","distance","carrier","lat.dest","lon.dest")])
```


### Calculate the training or apparent performance of the model.
```{r}
train <- trainControl(method = "cv", number = 10)
```


### Calculate an unbiased masure of performance
```{r warning = FALSE}
model <- train(y ~ dep_delay + month.flight + air_time + distance + carrier + lat.dest + lon.dest,
               data = data,
               trControl = train,
               method = "glm")
predictions <- ifelse(predict(model, data) > 0.5,1,0)
```


### Create a ROC Curve for your model (and also show a confusion matrix)
```{r}
confusionMatrix(predictions, as.numeric(data$y))
plot(roc(as.numeric(data$y), predictions))

```

# Exercise 2: caret/rpart (5 points)

Using the `caret` and `rpart` packages, create a **classification** model for flight delays using your NYC FLight data. Your solution should include:

### The use of `caret` and `rpart` to train a model.
```{r}
data <- data_orig
```

### Create a three-class dependent variable that is 2 when flight is late (arr_delay > 22 minutes), 1 when delayed (arr_delay [5,22)), and 0 otherwise
```{r}
data$y <- ifelse(as.numeric(data$arr_delay >= 22),2,
                 ifelse(as.numeric(data$arr_delay >= 5),1,0))

# Tabulate the newly dependent variable
table(data$y)

# Remove rows where predictions won't be fesible due to missingness in covariates (or response variable)
data <- na.omit(data[,c("y","dep_delay","month.flight","air_time","distance","carrier","lat.dest","lon.dest")])

```

### An articulation of the problem
We want to build a model to classify flights as on-time, delayed, and late.
We will use a tree to partition the data by 7 variables. For example, if a flight left 60 minutes after it's
scheduled departure time, we automatically consider it late. If not, then we enter another branch, and so on.


### A naive model: making all flights the most common class
```{r}
table(data$y)
#naive.model <- 

#- An unbiased calculation of the performance metric
#- A plot of your model -- (the actual tree; there are several ways to do this)
#- A discussion of your model 

```


### Questions:

- Discuss the difference between the models and why you would use one model over the other?
- How might you produce an ROC type curve for the *rpart* model? 
